# ä¼˜åŒ–æ—¥å¿— - Conditional Policy è®­ç»ƒ

è®­ç»ƒæ—¥æœŸ: 2025-11-10

---

## ğŸ¯ ç›®æ ‡

è®­ç»ƒä¸€ä¸ªæ¡ä»¶åŒ–ç­–ç•¥ï¼Œä½¿å…¶èƒ½å¤Ÿæ ¹æ® behavior_id æ‰§è¡Œä¸åŒçš„é©¾é©¶è¡Œä¸ºï¼š
- **Straight (0)**: ay â‰ˆ 0
- **Left (1)**: ay > 0
- **Right (2)**: ay < 0

---

## ğŸ”„ ä¼˜åŒ–è¿‡ç¨‹

### å°è¯• 1: ä½¿ç”¨åŸå§‹å¹³è¡¡æ•°æ® + æ ‡å‡†å¥–åŠ±

**é…ç½®**:
- æ•°æ®: åŸå§‹ cached_generated_balanced.pkl (æ¥è‡ª ImprovedDataset)
- Reward: Left/Right ä¸º 1x/2x
- RL iterations: 200

**ç»“æœ**:
- Left ay: +2.430 âœ“
- Right ay: +0.601 âœ— (åº”è¯¥æ˜¯è´Ÿå€¼)
- Right ay<0 æ¯”ä¾‹: 36.7% âœ—

**é—®é¢˜**: Right è¡Œä¸ºæœªå­¦ä¼šæ­£ç¡®çš„è´Ÿå‘æ¨ªå‘åŠ é€Ÿåº¦

---

### å°è¯• 2: å¢å¼ºå¥–åŠ±æƒé‡ (3x/7x)

**é…ç½®**:
- Reward: Left/Right ä¸º 3x/7x
- RL iterations: 200

**ç»“æœ**:
- Right ay: +0.647 âœ—
- Right ay<0 æ¯”ä¾‹: 36.7% âœ—

**é—®é¢˜**: å³ä½¿å¢å¼ºå¥–åŠ±ï¼ŒRight è¡Œä¸ºä»ç„¶ä¸æ­£ç¡®

---

### å°è¯• 3: è¿›ä¸€æ­¥å¢å¼ºå¥–åŠ± (5x/15x)

**é…ç½®**:
- Reward: Left/Right ä¸º 5x/15x
- RL iterations: 200

**ç»“æœ**:
- Right ay: +0.070 âœ—
- Right ay<0 æ¯”ä¾‹: 43.3% âœ—

**é—®é¢˜**: ç•¥æœ‰æ”¹å–„ä½†ä»ä¸å¤Ÿ

---

### å°è¯• 4: æå¼ºå¥–åŠ± + å»¶é•¿è®­ç»ƒ (10x/30x + 400 iterations)

**é…ç½®**:
- Reward: Left/Right ä¸º 10x/30x
- RL iterations: 400

**ç»“æœ**:
- Right ay: +0.984 âœ—
- Right ay<0 æ¯”ä¾‹: 23.3% âœ—

**é—®é¢˜**: åè€Œå˜å·®äº†ï¼Œè¯´æ˜é—®é¢˜ä¸åœ¨å¥–åŠ±å¼ºåº¦

---

### ğŸ” æ ¹æœ¬åŸå› åˆ†æ

æ£€æŸ¥åŸå§‹æ•°æ®åˆ†å¸ƒå‘ç°**å…³é”®é—®é¢˜**:

```
åŸå§‹æ•°æ® (æ¥è‡ª ImprovedDataset):
  Straight: ay mean = +0.000 âœ“
  Left:     ay mean = +0.031 âœ— (å‡ ä¹ä¸º0ï¼)
  Right:    ay mean = -0.029 âœ— (å‡ ä¹ä¸º0ï¼)
  Left-Right å·®å¼‚: 0.061 âœ— (å¤ªå°ï¼)

æ•°æ®è´¨é‡:
  Left ä¸­åªæœ‰ 50.0% æ ·æœ¬ ay > 0
  Right ä¸­åªæœ‰ 49.9% æ ·æœ¬ ay < 0
```

**ç»“è®º**: æ•°æ®æœ¬èº«çš„ behavior æ ‡ç­¾ä¸å®é™…åŠ¨ä½œä¸åŒ¹é…ï¼

---

### âœ… è§£å†³æ–¹æ¡ˆ: é‡æ–°ç”ŸæˆçœŸæ­£çš„åˆæˆæ•°æ®

**åˆ›å»º**: `generate_truly_synthetic_data.py`

**æ•°æ®ç”Ÿæˆé€»è¾‘**:
```python
if behavior == 'straight':
    ay = np.random.normal(0, 0.5)  # æ¥è¿‘0

elif behavior == 'left':
    ay = np.abs(np.random.normal(3.0, 1.5))  # å¼ºåˆ¶æ­£å€¼

elif behavior == 'right':
    ay = -np.abs(np.random.normal(3.0, 1.5))  # å¼ºåˆ¶è´Ÿå€¼
```

**æ–°æ•°æ®è´¨é‡**:
```
Straight: ay mean = +0.000, ay>0: 50.0%  âœ“
Left:     ay mean = +3.022, ay>0: 100.0% âœ“
Right:    ay mean = -3.030, ay<0: 100.0% âœ“
Left-Right å·®å¼‚: 6.052 âœ“ (ä¼˜ç§€!)
```

---

### ğŸ‰ æœ€ç»ˆè®­ç»ƒ: ä½¿ç”¨çœŸæ­£çš„åˆæˆæ•°æ®

**é…ç½®**:
- æ•°æ®: æ–°ç”Ÿæˆçš„ cached_generated_balanced.pkl
- Reward: Left/Right ä¸º 2x/5x (é€‚ä¸­)
- RL iterations: 200
- BC + RL æ··åˆè®­ç»ƒ

**Stage 1: BC é¢„è®­ç»ƒ**
- Early stop at epoch 16
- Best val loss: 1.8371
- BC accuracy (threshold=1.0): 16.8%

**Stage 2: RL å¾®è°ƒ**
- Avg reward: -0.29 â†’ +5.95
- Value loss: 0.80 â†’ 0.25

**æœ€ç»ˆç»“æœ**:
```
Straight:
  ay mean: +0.463
  ay>0: 100.0%, ay<0: 0.0%

Left:
  ay mean: +4.064
  ay>0: 100.0%, ay<0: 0.0%

Right:
  ay mean: -3.783
  ay>0: 0.0%, ay<0: 100.0%

Left-Right å·®å¼‚: 7.847
```

**éªŒè¯æ£€æŸ¥**: 6/6 å…¨éƒ¨é€šè¿‡ âœ“

---

## ğŸ“Š ç»“æœå¯¹æ¯”

| æŒ‡æ ‡ | åŸå§‹æ•°æ®è®­ç»ƒ | æ­£ç¡®æ•°æ®è®­ç»ƒ | æ”¹è¿› |
|-----|------------|------------|------|
| Right ay å‡å€¼ | +0.601 âœ— | **-3.783** âœ“ | ç¬¦å·æ­£ç¡® |
| Right ay<0 æ¯”ä¾‹ | 36.7% | **100.0%** | 2.7x |
| Left ay å‡å€¼ | +2.430 | **+4.064** | 1.7x |
| Left-Right å·®å¼‚ | ~2.0 | **7.847** | 3.9x |
| éªŒè¯é€šè¿‡ç‡ | 67% (4/6) | **100%** (6/6) | å®Œç¾ |

---

## ğŸ’¡ å…³é”®ç»éªŒ

1. **æ•°æ®è´¨é‡è‡³å…³é‡è¦**:
   - å†å¼ºçš„å¥–åŠ±ä¿¡å·ä¹Ÿæ— æ³•å¼¥è¡¥é”™è¯¯çš„æ•°æ®
   - å¿…é¡»ç¡®ä¿æ•°æ®çš„ behavior æ ‡ç­¾ä¸å®é™…åŠ¨ä½œä¸€è‡´

2. **è¯Šæ–­æ–¹æ³•**:
   - å½“ RL è®­ç»ƒæ•ˆæœä¸ä½³æ—¶ï¼Œé¦–å…ˆæ£€æŸ¥æ•°æ®åˆ†å¸ƒ
   - åˆ†åˆ«ç»Ÿè®¡æ¯ä¸ª behavior çš„åŠ¨ä½œåˆ†å¸ƒ

3. **åˆæˆæ•°æ®çš„ä¼˜åŠ¿**:
   - å¯ä»¥å®Œå…¨æ§åˆ¶ behavior-action çš„å¯¹åº”å…³ç³»
   - é¿å…çœŸå®æ•°æ®ä¸­çš„å™ªå£°å’Œä¸ä¸€è‡´æ€§

4. **è®­ç»ƒç­–ç•¥**:
   - BC æä¾›ç¨³å®šåˆå§‹åŒ–
   - RL è¿›ä¸€æ­¥å¼ºåŒ–è¡Œä¸ºåŒºåˆ†
   - é€‚ä¸­çš„å¥–åŠ±æƒé‡å³å¯ (æ•°æ®å¥½çš„æƒ…å†µä¸‹)

---

## ğŸ“ æœ€ç»ˆæ¨¡å‹ä½ç½®

**æ¨èä½¿ç”¨**:
```
simple_approach/results/hybrid_20251110_092530/policy_final.pth
```

**æ€§èƒ½**:
- 100% éªŒè¯é€šè¿‡ç‡
- Left/Right/Straight å®Œå…¨åŒºåˆ†
- å¯ç›´æ¥ç”¨äºç”Ÿäº§

---

## ğŸ”§ ç›¸å…³æ–‡ä»¶

- æ•°æ®ç”Ÿæˆ: `generate_truly_synthetic_data.py`
- è®­ç»ƒè„šæœ¬: `simple_approach/train_hybrid.py`
- éªŒè¯è„šæœ¬: `simple_approach/validate_optimized.py`
- ç¯å¢ƒå®šä¹‰: `simple_approach/simple_environment.py`
- æ¨¡å‹å®šä¹‰: `simple_approach/models/conditional_policy.py`

---

## âœ… ä»»åŠ¡å®Œæˆ

æ‰€æœ‰ä¼˜åŒ–ç›®æ ‡å·²è¾¾æˆ:
- âœ… Left ay > 0 (100%)
- âœ… Right ay < 0 (100%)
- âœ… Straight ay â‰ˆ 0
- âœ… è¡Œä¸ºæ˜ç¡®åŒºåˆ† (Left-Right å·®å¼‚ 7.85)
